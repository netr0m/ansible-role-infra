# Ansible Role: infra

[![CI](https://github.com/netr0m/ansible-role-infra/actions/workflows/ci.yml/badge.svg)](https://github.com/netr0m/ansible-role-infra/actions/workflows/ci.yml)

An Ansible role for infrastructure components as Docker containers. Handles tasks for deploying various services relating to self-hosting *infrastructure*.
| Service | Purpose | Enabled by default |
|---|---|---|
| [Pi-Hole](https://github.com/pi-hole/docker-pi-hole) | DNS, Ad-block | Yes |
| [Graylog](https://github.com/Graylog2/graylog-docker) | Log management | Yes |
| [Uptime-Kuma](https://github.com/louislam/uptime-kuma) | Uptime monitoring | Yes |
| [Vaultwarden](https://github.com/dani-garcia/vaultwarden) | Password management | Yes |
| [Authentik](https://github.com/goauthentik/authentik) | Identity management | Yes |
| [godns](https://github.com/TimothyYe/godns) | Dynamic DNS | No |
| [Wireguard](https://github.com/linuxserver/docker-wireguard) | Remote access VPN | No |
| [Unifi](https://github.com/linuxserver/docker-unifi-controller) | Unifi network management | No |
| [Wazuh](https://github.com/wazuh/wazuh) | Wazuh Security Platform | No |
| [Actual](https://github.com/actualbudget/actual) | Personal finance | No |

## Installation

```sh
$ ansible-galaxy install git+https://github.com/netr0m/ansible-role-infra.git
```

## Requirements

Requires the role [`netr0m.svc`](https://github.com/netr0m/ansible-role-svc)

## Role Variables

Available variables are listed in [`docs/default-variables.md`](./docs/default-variables.md) (see [`defaults/main.yml`](./defaults/main.yml))

### Minimal configuration [required]

Most of the defaults variables can be used as-is, but there are a few variables that must be set:

#### For [`netr0m.svc`](https://github.com/netr0m/ansible-role-svc)
```yml
# Username of the user owning the files
svc_user_name: 'service_username'
# Group name of the group that should own the files
svc_group_name: 'service_groupname'
```

#### For this role
```yml
# If `infra_use_authentik` is true, then
# Secret key used for Authentik cookie signing
infra_authentik_secret_key: "some-long-random-string"
# Database password
infra_authentik_db_password: ""

# If `infra_use_graylog` is true, then
# Secret used to 'pepper' the passwords - make sure to change this BEFORE deploying.
infra_graylog_password_secret: "super-long-random-string-minimum-64-chars"
# Hash of the password used for the root user [run `echo -n yourpassword | shasum -a 256`]
infra_graylog_password_sha2: "sha256-sum-of-your-password"

# If `infra_use_wazuh` is true, then
# Password for the wazuh indexer 'admin' user (infra_wazuh_indexer_admin_user)
infra_wazuh_indexer_admin_password: ~
# Password for the wazuh indexer 'dashboard' user (infra_wazuh_indexer_dashboard_user)
infra_wazuh_indexer_dashboard_password: ~
# Password for the wazuh api user (infra_wazuh_api_user). NB: The password for Wazuh API users must be between 8 and 64 characters long. It must contain at least one uppercase and one lowercase letter, a number, and a symbol.
infra_wazuh_api_password: ~

```

### Recommended configuration changes

#### Configure authentik as a forward proxy authentication provider

- Make sure to [Configure authentik as a "Forward Auth" proxy](./docs/authentik.md#configure-authentik-as-a-forward-auth-proxy) as well

```yml
# Enable authentik deployment
infra_use_authentik: true
# Enable for the various services
infra_graylog_use_authentik: true
infra_pihole_use_authentik: true
infra_unifi_use_authentik: true
infra_uptimekuma_use_authentik: true
infra_vaultwarden_use_authentik: true
infra_wazuh_use_authentik: true
infra_wireguard_use_authentik: true
```

#### Set the Pi-Hole admin portal password
```yml
# Password for Pihole web UI. Autogenerated if not set.
infra_pihole_password: donkeys-gamble-on-broadway55
```

#### Wireguard
```yml
# Enable Wireguard
infra_use_wireguard: true
# Set the external domain name
infra_domain_ext: mydomain.tld

# Peers to create. See https://github.com/linuxserver/docker-wireguard#parameters
infra_wireguard_peers:
  - laptop
  - desktop
  - phone
```

#### GODNS
```yml
# Optionally enable godns for DDNS (if you have dynamic DNS)
infra_use_godns: true
# DNS provider to use
infra_godns_provider: Cloudflare
# Email address for the DNS provider account
infra_godns_email: ~
# Password/Global API key (cloudflare) for the DNS provider account
infra_godns_password: ~
# Token for the DNS provider account
infra_godns_token: ~
# List of domains and subdomains to update
infra_godns_domains:
  - domain_name: "{{ infra_domain_ext }}"
    sub_domains:
      - "{{ infra_wireguard_container_hostname }}"
```

See [`netr0m.svc` - Recommended configuration changes](https://github.com/netr0m/ansible-role-svc#recommended-configuration-changes) for recommended changes (automated HTTPS and more).

## Dependencies

See [ansible-requirements.yml](./ansible-requirements.yml) for a list

### Installation
```sh
ansible-galaxy collection install -r ansible-requirements.yml
ansible-galaxy role install -r ansible-requirements.yml
```

## Example Playbook

```yml
---
- name: Example Playbook
  hosts: all
  become: true
  gather facts: true

  roles:
    - { role: netr0m.infra }
...

```

## Development
This project uses [pre-commit](https://pre-commit.com/).

Currently, there are three hooks:
- [ansible-lint](https://pypi.org/project/ansible-lint/)
- [yamllint](https://pypi.org/project/yamllint/)
- [encryption-check](./scripts/encryption-check.sh)

To run `pre-commit` manually, run `pre-commit run -a`

### Requirements
To run pre-commit, you need three things:
1. A virtual environment in the parent directory of this repository
  - `$ python3 -m venv ../.venv`
  - `$ source ../.venv/bin/activate`
2. The Python dependencies (see [requirements.txt](./requirements.txt))
  - `$ pip install -r requirements.txt`
3. Pre-commit hooks installed
  - `$ pre-commit install`

### Updating the 'variables' docs
This project provides a script for generating markdown files representing ansible (YAML) variable definitions.

An example can be seen in [`docs/default-variables.md`](./docs/default-variables.md), which is generated from the variables defined in [`defaults/main.yml`](./defaults/main.yml).

#### Running the script
To run the generator, issue the following command. If no parameters are specified, this will generate a markdown file based on the variables in `defaults/main.yml`, and write it to `docs/default-variables.md`.

```sh
$ python3 generate-vars-md.py

# Display help message
$ python3 generate-vars-md.py --help

# Specify alternative input and output paths
$ python3 generate-vars-md.py --in-file vars/debian.yml --out-file docs/debian-vars.md --title "Debian Variables"
```

## License

[MIT](./LICENSE)

## Author Information

This role was created in 2022 by [netr0m](https://github.com/netr0m)
